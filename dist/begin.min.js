/*! begin - v0.2.0 - 2015-10-26 */
!function(a){"use strict";function b(a){return new q(null,a)}function c(){this.init.apply(this,arguments)}function d(a){var b=typeof a;return null!=a&&("object"==b||"function"==b)&&"function"==typeof a.then}function e(a,b){a||(a={});for(var c in b){var d=b[c];null!=d?a[c]=b[c]:delete a[c]}return a}function f(a){a.superclass=this,a.prototype=Object.create(this.prototype,{constructor:{value:a,enumerable:!1},"class":{value:a,enumerable:!1}});for(var b in this)a[b]=this[b];return a}var g=b.ArgKind=1,h=b.ErrKind=2,i=b.BrkKind=4,j=b.RetKind=8,k=b.AllKind=15,l="STACK",m=Array.prototype.slice;"function"==typeof a.setImmediate?b.setImmediate=a.setImmediate:"function"==typeof setImmediate?b.setImmediate=setImmediate:"undefined"!=typeof process&&"function"==typeof process.nextTick?b.setImmediate=process.nextTick:"function"==typeof a.setTimeout?b.setImmediate=function(b){return a.setTimeout(b,0)}:b.setImmediate=function(a){return setTimeout(a,0)};var n=b.Call=function(a,b){this.status="new",this.block=a,this.context=b||{},this.error=void 0,this.params=[]};n.prototype.toString=function(){return this.constructor.name+"(error:"+this.error+",params:"+this.params.join(",")+(this.subcalls?",subcalls="+this.subcalls.length:"")+")"},n.prototype.run=function(a){if("new"!=this.status)throw new Error("Call cannot be run twice");if(!this.block)throw new Error("No block");var b=this;this.status="running",F&&F.emit("onBeginCall",this),this.block.run(this,function(){b.status="done",F&&F.emit("onEndCall",b),a&&a()})},n.prototype.set=function(a,b){if(void 0!==a&&(this.error=a),void 0!==b&&Array.isArray(b)){this.params.length=b.length;for(var c=b.length;c--;)this.params[c]=b[c]}},n.prototype.setParams=function(){this.params.length=arguments.length;for(var a=arguments.length;a--;)this.params[a]=arguments[a]},n.prototype.beginSubcall=function(a){var b=e({},this.context),c=new n(a||this.block,b);return c.set(this.error,this.params),(this.subcalls||(this.subcalls=[])).push(c),c.index=this.subcalls.length-1,1==this.subcalls.length&&(F&&F.emit("onOpenSubcalls",this),this.subcallErrors=[],this.subcallParams=[]),F&&F.emit("onBeginSubcall",this,c),c},n.prototype.endSubcall=function(a){if(!(a instanceof n))throw new Error("Subcall required (subcall="+a+")");a.commit(),this.subcallErrors[a.index]=a.error,this.subcallParams[a.index]=a.params[0],this.subcalls[a.index]=null,F&&F.emit("onEndSubcall",this,a)},n.prototype.commit=function(){if(null!=this.subcalls){var a=this.subcallsError;delete this.subcallsError;for(var b=0,c=this.subcallErrors.length;c>b;b++){var d=this.subcallErrors[b];null!=d&&(null==a?a=d:(a.message+="; "+(d.message||d),(a.errors||(a.errors=[])).push(d)))}return this.error=a,delete this.subcallErrors,this.params=this.subcallParams,delete this.subcallParams,delete this.subcalls,F&&F.emit("onCloseSubcalls",this),this}},c.extend=f,c.prototype.toString=function(){return this.constructor.name+"()"},c.prototype.init=function(){};var o=b.Stmt=function(a){this.owner=a,F&&F.emit("onCreateStmt",this)};o.kind=g,o.prototype.init=function(a){this.owner=a},o.prototype.toString=function(){return this.constructor.name+"()"},o.prototype.run=function(a,b){var c=this;F&&F.emit("onBeginRun",a,c),this._run(a,function(){F&&F.emit("onEndRun",a,c),b&&b.apply(null,arguments)})},o.prototype._run=function(a,b){b(args)},o.prototype.invoke=function(a,c,e){function f(){if(i)return void(F&&F.emit("onEndInvokeDup",a,a.stmt,c,f,arguments));F&&F.emit("onEndInvoke",a,a.stmt,c,f,arguments),a.stmt=a.replier=a.func=null;for(var d in f)g[d]=f[d];a.set(arguments[0],m.call(arguments,1)),h?b.setImmediate(e):e()}if(!(a instanceof n))throw new Error("Call must be a Call: "+a);var g=a.context;if("function"!=typeof e)throw new Error("Callback must be a function");if(c===l)return a.error=null,e();if(d(c))return c.then(function(b){a.setParams(b),e()},function(b){a.set(b),e()});if("function"!=typeof c)return a.setParams(c),e();var h=!0,i=!1;for(var j in g)f[j]=g[j];f.call=a;try{a.stmt=this,a.replier=f,a.func=c,F&&F.emit("onBeginInvoke",a,this,c,f);var k=c.apply(f,a.params);void 0!==k&&(d(k)?k.then(function(a){f(null,a)},function(a){f(a,null)}):f(null,k))}catch(o){f(o,null)}finally{h=!1}},o.extend=f,o.syncify=function(a){var b=this.prototype;b["class"].superclass.prototype;a.forEach(function(a){b[a];b[a+"Sync"]=function(b){return"function"==typeof b&&(arguments[0]=function(){return b.apply(this,arguments)||null}),this[a].apply(this,arguments)}})};var p=b.Block=o.extend(function(a){o.call(this,a),this.stmts=[]});p.kind=g|i,p.prototype.begin=function(){var a=new p(this);return this.stmts.push(a),a},p.prototype.end=function(a){var b=this.owner;return!b||b instanceof p||(b=b.owner),b},p.prototype._run=function(a,b){if(0==this.stmts.length)return b();var c=this,d=-1,e=this.stmts.length;!function f(){for(var k,l,m=a.error?"break"===a.error?i:"return"===a.error?j:h:g;e>d&&(k=c.stmts[++d],l=k&&k["class"].kind,!(l&m)););k?k.run(a,f):("break"===a.error&&(a.error=null),b())}()};var q=p.Root=p.extend(function(a,b,c){p.call(this,a),this.context=b,this.options=c||{}});b.promise=function(a,b){return b||(b={}),b.promise=!0,new q(null,a,b)},b.handler=function(a,b){return b||(b={}),b.handler=!0,new q(null,a,b)},b.callback=function(a,b){return b||(b={}),b.callback=!0,new q(null,a,b)},q.prototype.end=function(a){var b=this;if(this.options.handler)return function(){var c=new n(b);c.set(null,arguments),c.run(function(){if(a)a.apply(null,[c.error].concat(c.params));else if(c.error)throw c.error})};if(this.options.callback)return function(){var c=new n(b);c.set(arguments[0],m.call(arguments,1)),c.run(function(){if(a)a.apply(null,[c.error].concat(c.params));else if(c.error)throw c.error})};var c=new n(b),d=new E;return c.run(function(){c.error?d._reject(c.error):d._fulfill(c.params[0]),a&&a.apply(null,[c.error].concat(c.params))}),d};var r=b.Then=o.extend(function(a,b){o.call(this,a),this.func=b});r.prototype._run=function(a,b){this.invoke(a,this.func,function(){b()})},p.prototype.then=function(a){if(a){var b=new r(this,a);this.stmts.push(b)}return this};var s=b.If=o.extend(function(a,c,d){o.call(this,a),this.negate=!!d,this.conds=[c],this.blocks=[new b.Block(this)]});p.prototype["if"]=function(a){var b=new s(this,a,!1);return this.stmts.push(b),b.blocks[0]},p.prototype.unless=function(a){var b=new s(this,a,!0);return this.stmts.push(b),b.blocks[0]},p.prototype.elseif=function(a){if(!this.owner.elseif)throw new Error("Unexpected .elseif()");return this.owner.elseif(a)},p.prototype["else"]=function(){if(!this.owner["else"])throw new Error("Unexpected .else()");return this.owner["else"]()},p.syncify(["then"]),s.prototype._run=function(a,b){var c=this,d=a.params,e=0,f=this.blocks.length;!function g(){if(f>e){var h=c.conds[e],i=c.blocks[e];e++,a.set(void 0,d),c.invoke(a,h,function(){var d=(a.error,a.params[0]);return a.error?b():void(!!d==!c.negate?i.run(a,b):f>e?g():c.elseBlock?c.elseBlock.run(a,b):b())})}else b()}()},s.prototype.elseif=function(a){var b=new p(this);return this.conds.push(a),this.blocks.push(b),b},s.prototype["else"]=function(){return this.elseBlock=new p(this)};var t=b.Case=b.Stmt.extend(function(a,c){b.Stmt.call(this,a),this.control=c,this.conds=[],this.blocks=[],this.elseBlock=null});b.Block.prototype["case"]=function(a){0==arguments.length&&(a="STACK");var b=new t(this,a);return this.stmts.push(b),b},b.Block.prototype.when=function(a){if(!this.owner.when)throw new Error("Unexpected .when()");return arguments.length>1&&(a=m.call(arguments)),this.owner.when(a)},t.prototype.when=function(a){arguments.length>1&&(a=m.call(arguments));var c=new b.Block(this);return this.conds.push(a),this.blocks.push(c),c},t.prototype["else"]=function(){return this.elseBlock=new b.Block(this)},t.prototype.match=function(a,b){if(a==b)return!0;if(null==a||null==b)return!1;if(Array.isArray(b)){for(var c=0,d=b.length;d>c;c++)if(this.match(a,b[c]))return!0;return!1}return"string"==typeof a&&b instanceof RegExp?a.match(b):a.getTime&&b.getTime&&a.getTime()==b.getTime()?!0:!1},t.prototype._run=function(a,b){var c,d=this,e=0,f=this.blocks.length;d.invoke(a,this.control,function(){function g(){if(f>e){var h=d.conds[e],i=d.blocks[e];e++,a.params.splice(0,a.params.length,c),"function"==typeof h?d.invoke(a,h,function(){return a.error?b():void(a.params[0]?i.run(a,b):g())}):d.match(c,h)?i.run(a,b):g()}else d.elseBlock?d.elseBlock.run(a,b):b()}return a.error?b():(c=a.params[0],void g())})};var u=b.While=o.extend(function(a,b,c){o.call(this,a),this.opts=c||{},this.cond=b,this.block=new p(this)});u.kind=g|i,p.prototype["while"]=function(a,b){1==arguments.length&&(b=a,a=null);var c=new u(this,b,a);return this.stmts.push(c),c.block},p.prototype.until=function(a,b){return 1==arguments.length&&(b=a,a=null),a||(a={}),a.negate=!0,this["while"](b,a)},u.prototype.init=function(a,b,c){o.call(this,a),this.opts=c||{},this.cond=b,this.block=new p(this)},u.prototype._run=function(a,b){var c=this,d=this.cond,e=a.params.slice(),f=!!this.opts.negate,g=this.opts.interval||0;!function h(){var i=Date.now()+g;c.invoke(a,d,function(){var d=a.params[0];return a.error?(a.set(void 0,e),b()):void(!!d==!f?c.block.run(a,function(){if(a.error)return a.set(void 0,e),b();var c=i-Date.now();c>4?setTimeout(h,c):h()}):(a.set(void 0,e),b()))})}()},u.prototype.elseif=function(a){var b=new p(this);return this.conds.push(a),this.blocks.push(b),b},u.prototype["else"]=function(){return this.elseBlock=new p(this)};var v=b.Each=o.extend(function(a,b,c){o.call(this,a),this.opts=b||{},this.list=c,this.block=new p(this)});v.kind=g|i,p.prototype.each=function(a,b){1==arguments.length&&(b=a,a=null);var c=new v(this,a,b);return this.stmts.push(c),c.block},v.prototype._run=function(a,b){var c=this,d=this.block,e=Math.max(0,this.opts.workers)||1/0;this.items(a,function(){function f(){var c=j++,g=h[c],n=i[c],o=a.beginSubcall(d);o.params.splice(0,o.params.length,g,n),m++,d.run(o,function(){if(m--,k++,a.endSubcall(o),l>j)for(;e>m&&l>j;)f();else 0==m&&(a.commit(),a.params.splice(0,a.params.length,a.params.slice()),b())})}if(a.error)return b();var g=c.coerce(a.params[0]),h=g[0],i=g[1],j=0,k=0,l=h.length;if(0==l)return a.setParams([]),b();var m=0;for(Array(l);e>m&&l>j;)f()})},v.prototype.items=function(a,b){switch(typeof this.list){case"function":this.invoke(a,this.list,b);break;case"undefined":return b();default:return a.params=[this.list],b()}},v.prototype.coerce=function(a){var b=[],c=[];switch(typeof a){case"object":if(null==a)break;if(Array.isArray(a))for(var d=0,e=a.length;e>d;d++)b.push(a[d]),c.push(d);else for(var f in a)b.push(a[f]),c.push(f);break;case"number":for(var d=0;a>d;d++)c.push(d),b.push(d)}return[b,c]};var w=b.Split=o.extend(function(a){o.call(this,a),this.block=new p(this)});p.prototype.split=function(){var a=new w(this);return a.owner=this,this.stmts.push(a),a.block},w.prototype._run=function(a,b){for(var c=this.block,d=c.stmts,e=d.length,f=0,g=0;e>g;g++)!function(g){var h=d[g],i=a.beginSubcall(c);h.run(i,function(){a.endSubcall(i),++f==e&&(a.commit(),b())})}(g)};var x=b.Stream=o.extend(function(a,b,c){o.call(this,a),this.opts=b,this.stream=c,this.block=new p(this)});p.prototype.stream=function(a,b){var c;switch(arguments.length){case 0:b=l,a=null;break;case 1:b=a,a=null}var c=new x(this,a,b);return c.owner=this,this.stmts.push(c),c.block},x.prototype._run=function(a,b){var c=this,d=this.block,e=!1,f=0,g=0;a.params.slice();this.invoke(a,this.stream,function(){if(a.error)return b();var h=a.params[0],i=c.opts&&c.opts.data||"data",j=c.opts&&c.opts.error||"error",k=c.opts&&c.opts.close||"close";return null==h?(a.setParams([]),b()):(h.on(i,function(c){var i=a.beginSubcall(d);i.params=[c,f++,h],d.run(i,function(){g++,a.endSubcall(i),e&&g==f&&(a.commit(),a.params.splice(0,a.params.length,a.params.slice()),b())})}),h.once(j,function(c){e||(e=!0,a.subcallsError=c||"error",g==f&&(a.commit(),b()))}),void h.once(k,function(){e||(e=!0,g==f&&(a.commit(),b()))}))})};var y=b.Wait=o.extend(function(a,b){o.call(this,a),this.timeout=b||0});p.prototype.wait=function(a){var b=new y(this,a);return b.owner=this,this.stmts.push(b),this},y.prototype._run=function(a,b){setTimeout(function(){b()},this.timeout)};var z=b.Retry=o.extend(function(a,b){o.call(this,a),this.block=new p(this),this.count=b});z.kind=g|i,p.prototype.retry=function(a){var b=new z(this,a);return b.owner=this,this.stmts.push(b),b.block},z.prototype._run=function(a,b){function c(){e++>=this.count&&b(),d.run(a,function(a){return a?void 0:b&&b()})}var d=this.block,e=0;this.count;c()};var A=b.Catch=o.extend(function(a,b){o.call(this,a),this.func=b,this.func||(this.block=new p(this))});A.kind=h|i,p.prototype["catch"]=function(a){var b=new A(this,a);return this.stmts.push(b),b.block||this},A.prototype._run=function(a,b){a.params.splice(0,0,a.error),a.error=null,this.func?this.invoke(a,this.func,b):this.block&&this.block.run(a,b)};var B=b.Finally=o.extend(function(a,b){o.call(this,a),this.func=b,this.func||(this.block=new p(this))});B.kind=k|i,p.prototype["finally"]=function(a){var b=new B(this,a);return this.stmts.push(b),b.block||this},B.prototype._run=function(a,b){a.params.unshift(a.error),a.error=null,this.func?this.invoke(a,this.func,b):this.block&&this.block.run(a,b)};var C=b.Get=o.extend(function(a,b){o.call(this,a),this.keys=b});p.prototype.get=function(){var a=new C(this,m.call(arguments,0));return this.stmts.push(a),this},C.prototype._run=function(a,b){for(var c=0,d=this.keys.length;d>c;c++){var e=a.context[this.keys[c]];a.params.splice(c,0,e)}b()};var D=b.Set=o.extend(function(a,b){o.call(this,a),this.keys=b});p.prototype.set=function(a){var b=new D(this,m.call(arguments,0));return this.stmts.push(b),this},D.prototype._run=function(a,b){for(var c=0,d=this.keys.length;d>c;c++)a.context[this.keys[c]]=a.params[c];b()};var E=b.Promise=function(a){if(a)try{a(this._fulfill.bind(this),this._reject.bind(this))}catch(b){this._reject(b)}};E.PENDING=0,E.REJECTED=1,E.FULFILLED=2,E.RESOLVED=E.REJECTED&E.FULFILLED,E.prototype._call=function(a){var b,c,d,e=a._promise;switch(this._state){case 1:b="_reject",d=this._error;break;case 2:b="_fulfill",d=this._value;break;default:throw new Error("Must be resolved")}if(c=a[b])try{if(a._called)throw new Error("Next already called");a._called=!0;var f=c(d);if(f&&"function"==typeof f.then)try{f.then(e._fulfill.bind(e),e._reject.bind(e))}catch(g){e._reject(g)}else e._fulfill(f)}catch(g){e._reject(g)}else e[b](this._value)},E.prototype.then=function(a,c){var d=new E,e={_fulfill:"function"==typeof a?a:null,_reject:"function"==typeof c?c:null,_promise:d};return this._state?b.setImmediate(this._call.bind(this,e)):this._nexts?this._nexts.push(e):this._nexts=[e],d},E.prototype["catch"]=function(a){return this.then(null,a)},E.prototype._fulfill=function(a){return this._state?void 0:(this._state=2,this._value=a,this._flush())},E.prototype._reject=function(a){return this._state?void 0:(this._state=1,this._error=a,this._flush())},E.prototype._flush=function(a){if(this._nexts){for(var c=0,d=this._nexts.length;d>c;c++)b.setImmediate(this._call.bind(this,this._nexts[c]));delete this._nexts}return this};var F=null,G=b.Hook=function I(){if(this.constructor===I)throw new Error("Hook is abstract");this.init.apply(this,arguments)};if(G.extend=f,G.init=function(){},G.count=function(){for(var a=0,b=F;b;b=b._next)a++;return a},G.dump=function(){for(var a=[],b=F;b;b=b._next)a.push(b);for(var b=F,c=0,d=a.length;d>c;c++,b=b._next){var e=0==c?null==b._prev:b._prev==a[c-1],f=c==d-1?null==b._next:b._next=a[c+1];console.log("  "+(c+1)+". "+(e?"-":"P")+" "+(f?"-":"N")+" "+F.constructor)}},G.prototype.init=function(){},G.prototype.install=function(){if(!F)return G.instrument(),F=this;for(var a,b=F;a=b._next;b=a);return this._prev=b,b._next=this},G.prototype.uninstall=function(){var a=this._prev,b=this._next;a&&(this._prev=null,a._next=b),b&&(this._next=null,b._prev=a),F===this&&((F=b)||G.uninstrument())},G.instrument=function(){},G.uninstrument=function(){},G.prototype.emit=function(a,b){if(Array.isArray(b)||(b=m.call(arguments,1)),this[a])try{this[a].apply(this,b)}catch(c){console.log("begin: IMPL Hook, "+this+", while handling event, '"+a+"', produced error: "+c+"\n    "+(c.stack.join?c.stack.join("\n    "):c.stack))}this._next&&this._next.emit(a,b)},"undefined"!=typeof define&&define.amd)define("begin",[],function(){return b});else if("undefined"!=typeof module&&module.exports)module.exports=b;else{var H=a.begin;a.begin=b,a.begin.noConflict=function(){return a.begin=H,b}}}(this);
//# sourceMappingURL=begin.min.js.map